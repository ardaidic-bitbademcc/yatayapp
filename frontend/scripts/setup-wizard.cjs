#!/usr/bin/env node

/**
 * Interactive Environment Setup Wizard
 * 
 * KullanÄ±cÄ±ya environment variable'larÄ± ayarlamasÄ± iÃ§in interaktif rehberlik eder.
 */

const fs = require('fs');
const path = require('path');
const readline = require('readline');
const crypto = require('crypto');

const ENV_FILE = path.join(__dirname, '../.env.local');
const ENV_EXAMPLE = path.join(__dirname, '../.env.example');

const rl = readline.createInterface({
  input: process.stdin,
  output: process.stdout
});

// ANSI colors
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  red: '\x1b[31m',
  yellow: '\x1b[33m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
  bold: '\x1b[1m'
};

function log(message, color = colors.reset) {
  console.log(color + message + colors.reset);
}

function question(prompt) {
  return new Promise((resolve) => {
    rl.question(prompt, resolve);
  });
}

async function setupWizard() {
  log('\nğŸš€ YatayApp Environment Setup Wizard\n', colors.bold + colors.cyan);
  
  const envVars = {};

  // Check if .env.local exists
  if (fs.existsSync(ENV_FILE)) {
    log('âš ï¸  .env.local dosyasÄ± zaten mevcut.', colors.yellow);
    const overwrite = await question('   Ãœzerine yazmak ister misin? (y/N): ');
    if (overwrite.toLowerCase() !== 'y') {
      log('\nâŒ Kurulum iptal edildi. Mevcut dosya korundu.\n', colors.red);
      rl.close();
      return;
    }
    
    // Backup existing file
    const backupFile = ENV_FILE + '.backup.' + Date.now();
    fs.copyFileSync(ENV_FILE, backupFile);
    log(`   âœ… Mevcut dosya yedeklendi: ${path.basename(backupFile)}\n`, colors.green);
  }

  log('ğŸ“ Gerekli bilgileri sÄ±rayla girelim:\n', colors.bold);

  // 1. Supabase URL
  log('1ï¸âƒ£  Supabase Project URL', colors.cyan);
  log('   NasÄ±l bulunur: https://app.supabase.com â†’ Project â†’ Settings â†’ API', colors.blue);
  const supabaseUrl = await question('   URL: ');
  if (!supabaseUrl || !supabaseUrl.includes('supabase.co')) {
    log('   âš ï¸  GeÃ§ersiz URL, boÅŸ bÄ±rakÄ±ldÄ±', colors.yellow);
  } else {
    envVars.NEXT_PUBLIC_SUPABASE_URL = supabaseUrl;
    log('   âœ… Kaydedildi\n', colors.green);
  }

  // 2. Supabase Anon Key
  log('2ï¸âƒ£  Supabase Anon Key', colors.cyan);
  log('   AynÄ± sayfadan "anon" / "public" key\'i kopyala', colors.blue);
  const anonKey = await question('   Key: ');
  if (!anonKey || anonKey.length < 20) {
    log('   âš ï¸  GeÃ§ersiz key, boÅŸ bÄ±rakÄ±ldÄ±', colors.yellow);
  } else {
    envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY = anonKey;
    log('   âœ… Kaydedildi\n', colors.green);
  }

  // 3. Demo Mode
  log('3ï¸âƒ£  Demo Mode (Opsiyonel)', colors.cyan);
  log('   Demo butonlarÄ±nÄ± aktif etmek ister misin?', colors.blue);
  const demoMode = await question('   Aktif et? (Y/n): ');
  if (demoMode.toLowerCase() !== 'n') {
    envVars.NEXT_PUBLIC_DEMO_MODE = 'true';
    
    // Auto-generate demo setup token
    const demoToken = crypto.randomBytes(32).toString('hex');
    envVars.DEMO_SETUP_TOKEN = demoToken;
    
    log('   âœ… Demo mode aktif edildi', colors.green);
    log('   âœ… GÃ¼venli token otomatik oluÅŸturuldu\n', colors.green);
  } else {
    envVars.NEXT_PUBLIC_DEMO_MODE = 'false';
    log('   â„¹ï¸  Demo mode kapalÄ±\n', colors.blue);
  }

  // 4. Service Role Key (for E2E)
  log('4ï¸âƒ£  Supabase Service Role Key (Opsiyonel - E2E testler iÃ§in)', colors.cyan);
  log('   âš ï¸  Bu key admin yetkilerine sahiptir!', colors.yellow);
  log('   NasÄ±l bulunur: Supabase Dashboard â†’ Settings â†’ API â†’ "service_role"', colors.blue);
  const wantServiceRole = await question('   Eklemek ister misin? (y/N): ');
  if (wantServiceRole.toLowerCase() === 'y') {
    const serviceRole = await question('   Service Role Key: ');
    if (serviceRole && serviceRole.length > 20) {
      envVars.SUPABASE_SERVICE_ROLE_KEY = serviceRole;
      log('   âœ… Kaydedildi (E2E testler Ã§alÄ±ÅŸacak)\n', colors.green);
    } else {
      log('   âš ï¸  GeÃ§ersiz key, atlandÄ±\n', colors.yellow);
    }
  } else {
    log('   â„¹ï¸  AtlandÄ± (E2E testler skip edilecek)\n', colors.blue);
  }

  // 5. Sentry (Optional)
  log('5ï¸âƒ£  Sentry DSN (Opsiyonel - Error tracking)', colors.cyan);
  const wantSentry = await question('   Eklemek ister misin? (y/N): ');
  if (wantSentry.toLowerCase() === 'y') {
    const sentryDsn = await question('   Sentry DSN: ');
    if (sentryDsn && sentryDsn.startsWith('https://')) {
      envVars.NEXT_PUBLIC_SENTRY_DSN = sentryDsn;
      log('   âœ… Kaydedildi\n', colors.green);
    } else {
      log('   âš ï¸  GeÃ§ersiz DSN, atlandÄ±\n', colors.yellow);
    }
  } else {
    log('   â„¹ï¸  AtlandÄ±\n', colors.blue);
  }

  // Write to .env.local
  log('ğŸ’¾ .env.local dosyasÄ± oluÅŸturuluyor...\n', colors.bold);
  
  let envContent = '# Auto-generated by setup-wizard.cjs\n';
  envContent += '# ' + new Date().toISOString() + '\n\n';
  envContent += '# Supabase Configuration\n';
  envContent += `NEXT_PUBLIC_SUPABASE_URL=${envVars.NEXT_PUBLIC_SUPABASE_URL || ''}\n`;
  envContent += `NEXT_PUBLIC_SUPABASE_ANON_KEY=${envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY || ''}\n\n`;
  
  if (envVars.NEXT_PUBLIC_DEMO_MODE) {
    envContent += '# Demo Mode\n';
    envContent += `NEXT_PUBLIC_DEMO_MODE=${envVars.NEXT_PUBLIC_DEMO_MODE}\n`;
    if (envVars.DEMO_SETUP_TOKEN) {
      envContent += `DEMO_SETUP_TOKEN=${envVars.DEMO_SETUP_TOKEN}\n\n`;
    }
  }
  
  if (envVars.SUPABASE_SERVICE_ROLE_KEY) {
    envContent += '# Admin Operations (E2E Tests)\n';
    envContent += `SUPABASE_SERVICE_ROLE_KEY=${envVars.SUPABASE_SERVICE_ROLE_KEY}\n\n`;
  }
  
  if (envVars.NEXT_PUBLIC_SENTRY_DSN) {
    envContent += '# Error Tracking\n';
    envContent += `NEXT_PUBLIC_SENTRY_DSN=${envVars.NEXT_PUBLIC_SENTRY_DSN}\n\n`;
  }

  fs.writeFileSync(ENV_FILE, envContent);
  
  log('âœ… .env.local dosyasÄ± oluÅŸturuldu!\n', colors.green + colors.bold);
  
  // Summary
  log('ğŸ“Š Ã–zet:', colors.bold);
  log('   â€¢ Supabase URL: ' + (envVars.NEXT_PUBLIC_SUPABASE_URL ? 'âœ…' : 'âŒ'), envVars.NEXT_PUBLIC_SUPABASE_URL ? colors.green : colors.red);
  log('   â€¢ Supabase Anon Key: ' + (envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY ? 'âœ…' : 'âŒ'), envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY ? colors.green : colors.red);
  log('   â€¢ Demo Mode: ' + (envVars.NEXT_PUBLIC_DEMO_MODE === 'true' ? 'âœ… Aktif' : 'âŒ KapalÄ±'), envVars.NEXT_PUBLIC_DEMO_MODE === 'true' ? colors.green : colors.yellow);
  log('   â€¢ Service Role Key: ' + (envVars.SUPABASE_SERVICE_ROLE_KEY ? 'âœ… Var' : 'âŒ Yok'), envVars.SUPABASE_SERVICE_ROLE_KEY ? colors.green : colors.yellow);
  log('   â€¢ Sentry: ' + (envVars.NEXT_PUBLIC_SENTRY_DSN ? 'âœ… Var' : 'âŒ Yok'), envVars.NEXT_PUBLIC_SENTRY_DSN ? colors.green : colors.yellow);
  
  log('\nğŸ‰ Kurulum tamamlandÄ±!', colors.green + colors.bold);
  log('\nğŸ“ Sonraki adÄ±mlar:', colors.cyan);
  log('   1. npm run check:env  # Kontrol et');
  log('   2. npm run dev        # GeliÅŸtirme sunucusunu baÅŸlat\n');
  
  rl.close();
}

// Run wizard
setupWizard().catch(err => {
  log('\nâŒ Hata: ' + err.message, colors.red);
  rl.close();
  process.exit(1);
});
